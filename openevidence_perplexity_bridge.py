"""\nOpenEvidence-Perplexity API Bridge\n\nThis module provides a seamless interface between OpenEvidence API and Perplexity API,\nallowing Perplexity to access clinical evidence-based information from OpenEvidence.\n"""\n\nimport os\nimport requests\nfrom typing import Dict, List, Optional\nimport json\n\n\nclass OpenEvidenceClient:\n    \"\"\"Client for interacting with OpenEvidence API\"\"\"\n    \n    def __init__(self, api_key: str = None, base_url: str = None):\n        self.api_key = api_key or os.getenv('OPENEVIDENCE_API_KEY')\n        self.base_url = base_url or os.getenv('OPENEVIDENCE_BASE_URL', 'https://api.openevidence.com')\n        self.headers = {\n            'Authorization': f'Bearer {self.api_key}',\n            'Content-Type': 'application/json'\n        }\n    \n    def search(self, query: str, options: Optional[Dict] = None) -> Dict:\n        \"\"\"\n        Search OpenEvidence for clinical evidence\n        \n        Args:\n            query: Clinical question or search query\n            options: Additional search parameters\n        \n        Returns:\n            Dict containing search results with evidence and citations\n        \"\"\"\n        endpoint = f'{self.base_url}/search'\n        payload = {'query': query}\n        if options:\n            payload.update(options)\n        \n        try:\n            response = requests.post(endpoint, headers=self.headers, json=payload)\n            response.raise_for_status()\n            return response.json()\n        except requests.exceptions.RequestException as e:\n            return {'error': str(e), 'status': 'failed'}\n\n\nclass PerplexityClient:\n    \"\"\"Client for interacting with Perplexity API\"\"\"\n    \n    def __init__(self, api_key: str = None, base_url: str = None):\n        self.api_key = api_key or os.getenv('PERPLEXITY_API_KEY')\n        self.base_url = base_url or 'https://api.perplexity.ai'\n        self.headers = {\n            'Authorization': f'Bearer {self.api_key}',\n            'Content-Type': 'application/json'\n        }\n    \n    def chat_completion(self, messages: List[Dict], model: str = 'sonar', **kwargs) -> Dict:\n        \"\"\"\n        Send chat completion request to Perplexity\n        \n        Args:\n            messages: List of message objects\n            model: Model to use (default: sonar)\n            **kwargs: Additional parameters\n        \n        Returns:\n            Dict containing Perplexity response\n        \"\"\"\n        endpoint = f'{self.base_url}/chat/completions'\n        payload = {\n            'model': model,\n            'messages': messages,\n            **kwargs\n        }\n        \n        try:\n            response = requests.post(endpoint, headers=self.headers, json=payload)\n            response.raise_for_status()\n            return response.json()\n        except requests.exceptions.RequestException as e:\n            return {'error': str(e), 'status': 'failed'}\n\n\nclass OpenEvidencePerplexityBridge:\n    \"\"\"Bridge between OpenEvidence and Perplexity APIs\"\"\"\n    \n    def __init__(self, openevidence_key: str = None, perplexity_key: str = None):\n        self.oe_client = OpenEvidenceClient(api_key=openevidence_key)\n        self.perplexity_client = PerplexityClient(api_key=perplexity_key)\n    \n    def query_with_evidence(self, clinical_query: str, context: Optional[str] = None) -> Dict:\n        \"\"\"\n        Query Perplexity with clinical evidence from OpenEvidence\n        \n        Args:\n            clinical_query: The clinical question to answer\n            context: Additional context for the query\n        \n        Returns:\n            Dict containing combined response with evidence\n        \"\"\"\n        # Step 1: Get evidence from OpenEvidence\n        oe_results = self.oe_client.search(clinical_query)\n        \n        if 'error' in oe_results:\n            return {\n                'status': 'error',\n                'message': f'OpenEvidence error: {oe_results[\"error\"]}'\n            }\n        \n        # Step 2: Format evidence for Perplexity\n        evidence_context = self._format_evidence(oe_results)\n        \n        # Step 3: Construct Perplexity prompt with evidence\n        messages = [\n            {\n                'role': 'system',\n                'content': 'You are a clinical AI assistant with access to evidence-based medical information. Use the provided clinical evidence to answer questions accurately.'\n            },\n            {\n                'role': 'user',\n                'content': f'Clinical Evidence:\\n{evidence_context}\\n\\nQuestion: {clinical_query}'\n            }\n        ]\n        \n        if context:\n            messages[1]['content'] = f'{context}\\n\\n{messages[1][\"content\"]}'\n        \n        # Step 4: Get Perplexity response\n        perplexity_response = self.perplexity_client.chat_completion(messages)\n        \n        # Step 5: Combine results\n        return {\n            'status': 'success',\n            'query': clinical_query,\n            'evidence': oe_results,\n            'response': perplexity_response,\n            'combined_answer': self._extract_answer(perplexity_response)\n        }\n    \n    def _format_evidence(self, oe_results: Dict) -> str:\n        \"\"\"Format OpenEvidence results for Perplexity context\"\"\"\n        if not oe_results or 'results' not in oe_results:\n            return 'No evidence found.'\n        \n        formatted = []\n        for idx, result in enumerate(oe_results.get('results', [])[:5], 1):\n            formatted.append(f'{idx}. {result.get(\"summary\", \"N/A\")}')\n            if 'citation' in result:\n                formatted.append(f'   Citation: {result[\"citation\"]}')\n        \n        return '\\n'.join(formatted)\n    \n    def _extract_answer(self, perplexity_response: Dict) -> str:\n        \"\"\"Extract answer from Perplexity response\"\"\"\n        if 'error' in perplexity_response:\n            return f'Error: {perplexity_response[\"error\"]}'\n        \n        choices = perplexity_response.get('choices', [])\n        if choices:\n            return choices[0].get('message', {}).get('content', 'No answer generated')\n        return 'No answer generated'\n\n\n# Example usage\nif __name__ == '__main__':\n    # Initialize bridge\n    bridge = OpenEvidencePerplexityBridge()\n    \n    # Example clinical query\n    query = 'What is the recommended treatment for acute myocardial infarction?'\n    \n    # Get evidence-backed response\n    result = bridge.query_with_evidence(query)\n    \n    print(json.dumps(result, indent=2))
